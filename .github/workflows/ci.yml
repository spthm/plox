name: Lint and test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  tests:
    name: Lint and test

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-20.04]
        python-version: ["3.9", "3.10"]

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v2

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}

    - name: Get Python version
      id: python-version
      run: |
        echo ::set-output name=version::$(python --version | tr -d "Python ")

    - name: Get Tox env
      id: tox-env
      run: |
        echo ::set-output name=env::$(echo py${{ matrix.python-version }} | tr -d .)

    - name: Install poetry
      run: |
        # 1.1.13. Note that 1.2+ will require the even more dubious curl -sSL https://install.python-poetry.org | python -
        curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/68649946fe09d52ed1a5844bda6690ba6327c408/get-poetry.py > /tmp/get-poetry.py
        echo "e973b3badb95a916bfe250c22eeb7253130fd87312afa326eb02b8bdcea8f4a7  /tmp/get-poetry.py" | sha256sum --check
        python /tmp/get-poetry.py

    - name: Add poetry to PATH
      run: |
        echo "$HOME/.poetry/bin" >> $GITHUB_PATH

    - name: Configure poetry
      run: |
        poetry config virtualenvs.in-project true

    - name: Cache virtual environment
      uses: actions/cache@v3.0.1
      with:
        # Need be careful what we pull back from the cache here. The full Python
        # version (including patch) and OS version should match, otherwise we're
        # likely to run into 'bad interpreter' errors.
        key: venv-ci-${{ matrix.os }}-${{ runner.arch }}-${{ steps.python-version.outputs.version }}-${{ hashFiles('poetry.lock') }}
        path: .venv

    - name: Cache mypy cache
      uses: actions/cache@v3.0.1
      with:
        # Don't need to be so careful here,
        #   https://github.com/python/mypy/issues/10221#issuecomment-801330908
        key: mypy-cache-ci-${{ runner.os }}-${{ matrix.python-version }}
        path: .mypy_cache

    - name: Install dependencies
      run: |
        poetry install

    - name: Check formatting with black and isort
      run: |
        poetry run isort --check --diff src/ tests/
        poetry run black --check --diff src/ tests/

    - name: Lint with flake8, pylint and mypy
      run: |
        poetry run flake8 --show-source src/ tests/
        poetry run pylint src/ tests/
        poetry run mypy src/ tests/

    - name: Run tests
      # We only want to *see* test results in this step, not coverage info.
      run: |
        poetry run tox -e ${{ steps.tox-env.outputs.env }} -- --cov --cov-config=pyproject.toml --cov-report=

    - name: Upload coverage data for Python ${{ matrix.python-version }}
      uses: actions/upload-artifact@v3
      with:
        name: coverage-data
        path: ".coverage.${{ steps.tox-env.outputs.env }}"

  coverage:
    name: Produce coverage report

    needs: tests

    runs-on: ubuntu-latest

    steps:
        # Get our coverage configuration file (pyproject.toml).
      - uses: actions/checkout@v2

      - uses: actions/setup-python@v2
        with:
          python-version: "3.10"

      - name: Install coverage
        run: python -m pip install coverage[toml]

      - name: Download all coverage data
        uses: actions/download-artifact@v3
        with:
          name: coverage-data

      - name: Combine coverage reports
        run: |
          python -m coverage combine
          python -m coverage xml
          python -m coverage report

      - name: Upload coverage report to Codecov
        uses: codecov/codecov-action@v2
